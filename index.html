<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Meal Planner</title>

  <!-- React + Babel (no build step) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#172554;
      --card:#0f172a;
      --card2:#111c33;
      --text:#e5e7eb;
      --muted:#a7b0c0;
      --border: rgba(255,255,255,0.08);
      --accent:#60a5fa;
      --accent2:#34d399;
      --danger:#fb7185;
      --warn:#fbbf24;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(96,165,250,0.22), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(52,211,153,0.16), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    a{color:var(--accent)}
    .wrap{max-width:1150px;margin:0 auto;padding:18px 14px 50px;}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:16px;}
    .title h1{margin:0;font-size:22px;letter-spacing:0.2px}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{border:1px solid var(--border);background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns: 360px 1fr; gap:14px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:16px;
      padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .card h2{margin:0 0 10px;font-size:14px;letter-spacing:0.25px;color:#f3f4f6}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row + .row{margin-top:10px}
    label{font-size:12px;color:var(--muted)}
    input, select{
      background:rgba(0,0,0,0.25);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:9px 10px;
      outline:none;
      font-size:13px;
    }
    input[type="number"]{width:95px}
    .btn{
      cursor:pointer;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      font-size:13px;
      transition:transform .05s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,0.10)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color: rgba(96,165,250,0.35); background: rgba(96,165,250,0.16)}
    .btn.primary:hover{background: rgba(96,165,250,0.22)}
    .btn.good{border-color: rgba(52,211,153,0.35); background: rgba(52,211,153,0.14)}
    .btn.good:hover{background: rgba(52,211,153,0.20)}
    .btn.danger{border-color: rgba(251,113,133,0.35); background: rgba(251,113,133,0.14)}
    .btn.danger:hover{background: rgba(251,113,133,0.20)}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 9px;border-radius:10px;font-size:12px}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted)}
    .kv strong{color:var(--text);font-weight:600}
    .list{display:flex;flex-direction:column;gap:8px}
    .tag{
      font-size:11px;color:rgba(229,231,235,0.9);
      padding:3px 8px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.18);
      display:inline-flex;align-items:center;gap:6px;
    }
    .tag.bad{border-color: rgba(251,113,133,0.35); background: rgba(251,113,133,0.12)}
    .tag.ok{border-color: rgba(52,211,153,0.35); background: rgba(52,211,153,0.10)}
    .tag.warn{border-color: rgba(251,191,36,0.35); background: rgba(251,191,36,0.10)}
    .chipwrap{display:flex;flex-wrap:wrap;gap:6px}
    .item{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.18);
      border-radius:14px;
      padding:10px 10px;
    }
    .item .meta{display:flex;flex-direction:column;gap:2px}
    .item .meta .name{font-size:13px}
    .item .meta .sub{font-size:12px;color:var(--muted)}
    .rightcol{display:flex;flex-direction:column;gap:14px}
    .planGrid{display:grid;grid-template-columns: 1fr; gap:10px;}
    .planCard{
      border:1px solid var(--border);
      background:rgba(0,0,0,0.20);
      border-radius:16px;
      padding:12px;
    }
    .planCardHeader{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .planCardHeader .titleLine{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .planCardHeader .mealName{font-size:14px;font-weight:650}
    .planCardHeader .metaLine{color:var(--muted);font-size:12px;margin-top:4px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hstack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .footnote{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35}

    /* Modal (improved readability) */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,0.82);
      backdrop-filter: blur(4px);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(860px, 100%);
      max-height: 86vh;
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.96));
      box-shadow: 0 22px 80px rgba(0,0,0,0.6);
      padding:16px;
    }
    .modal h3{margin:0 0 8px;font-size:18px;letter-spacing:0.2px}
    .modal .subhead{color:var(--muted);font-size:13px;margin-bottom:12px}
    .modalSection{margin-top:12px}
    .modalSection h4{margin:0 0 8px;font-size:13px;color:#f3f4f6}
    .ingList{display:flex;flex-direction:column;gap:8px}
    .ingRow{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      border-radius:12px;
      padding:9px 10px;
    }
    .ingRow .left{display:flex;flex-direction:column;gap:2px}
    .ingRow .left .nm{font-size:13px}
    .ingRow .left .meta{font-size:12px;color:var(--muted)}
    .stepList{margin:0;padding-left:18px;color:#e5e7eb;font-size:13px;line-height:1.55}
    .stepList li{margin:6px 0}
    .xbtn{float:right}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;color:rgba(229,231,235,0.9);
      border:1px solid var(--border);padding:2px 6px;border-radius:7px;background:rgba(0,0,0,0.22)
    }

    /* Grocery */
    .gAisle{margin-top:10px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .gHead{padding:10px 12px;background:rgba(255,255,255,0.04);display:flex;justify-content:space-between;gap:12px;align-items:center}
    .gHead strong{font-size:13px}
    .gBody{padding:10px 12px;display:flex;flex-direction:column;gap:8px;background:rgba(0,0,0,0.15)}
    .gItem{display:flex;justify-content:space-between;gap:10px;align-items:baseline}
    .gItem .left{display:flex;flex-direction:column;gap:2px}
    .gItem .left .nm{font-size:13px}
    .gItem .left .note{font-size:12px;color:var(--muted)}
    .gItem .qty{font-size:13px;color:#f3f4f6;white-space:nowrap}

    /* tiny helpers */
    .switch{display:flex;gap:8px;align-items:center}
    .switch input{width:18px;height:18px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  </style>
</head>

<body>
  <div id="root"></div>
<script>
  window.addEventListener("error", (e) => {
    const pre = document.createElement("pre");
    pre.style.cssText = "position:fixed;inset:12px;z-index:99999;background:#0b1220;color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:12px;overflow:auto;white-space:pre-wrap;font:12px ui-monospace,Menlo,Consolas,monospace";
    pre.textContent = "App error:\n\n" + (e.error?.stack || e.message || String(e));
    document.body.appendChild(pre);
  });
</script>
  <script type="text/babel" data-presets="env,react">
    const STORAGE_KEY = "tj-costco-planner-static-v26";

    /**********************
     * Meal Library (your current set)
     **********************/
    const MEAL_ROWS = [
      // Beef (12)
      ["beef-01","Garlic-lime steak + fajita peppers & onions + cilantro rice","beef","mexican","peppers,onions","rice",0,0,1,
        "Bell peppers (mixed)|3|each|Produce;Yellow onion|1|each|Produce;Cilantro|1|each|Produce;Limes|2|each|Produce;Jasmine rice|1|bag|Pantry;Chili-lime seasoning|1|each|Spices/Sauces",
        "Sear steak; rest & slice|Sauté peppers + onions|Cook rice; stir in cilantro + lime"
      ],
      ["beef-02","Korean-style beef bowls + mushrooms + spinach + orzo","beef","korean","mushrooms,spinach","orzo",0,1,1,
        "Cremini mushrooms|1|pack|Produce;Baby spinach|1|bag|Produce;Orzo|1|box|Pantry;Soy sauce|1|bottle|Spices/Sauces;Sesame oil|1|bottle|Spices/Sauces;Green onions|1|each|Produce",
        "Brown beef with soy/ginger/garlic|Sauté mushrooms; wilt spinach|Serve over orzo; top green onion"
      ],
      ["beef-03","Beef stir-fry + cauliflower + snap peas + rice","beef","chinese","cauliflower,snap peas","rice",0,0,1,
        "Cauliflower florets|1|bag|Frozen;Sugar snap peas|1|bag|Produce;Jasmine rice|1|bag|Pantry;Soy sauce|1|bottle|Spices/Sauces;Rice vinegar|1|bottle|Spices/Sauces",
        "Sear beef strips|Stir-fry veg|Toss with soy + vinegar; serve with rice"
      ],
      ["beef-04","Chimichurri steak + roasted asparagus + crispy potatoes","beef","latin","asparagus","potatoes",0,0,0,
        "Asparagus|1|each|Produce;Baby potatoes|1|bag|Produce;Parsley|1|each|Produce;Lemon|1|each|Produce;Red wine vinegar|1|bottle|Spices/Sauces",
        "Roast potatoes; add asparagus near end|Sear steak|Blend chimichurri; spoon over"
      ],
      ["beef-05","Taco bowls (beef) + romaine + tomatoes + corn + black beans","beef","mexican","romaine,tomatoes,corn","rice",0,0,1,
        "Romaine hearts|1|pack|Produce;Cherry tomatoes|1|pack|Produce;Frozen roasted corn|1|bag|Frozen;Black beans|2|can|Pantry;Brown rice|1|bag|Pantry;Salsa|1|jar|Deli/Prepared;Avocados|2|each|Produce",
        "Cook rice; warm beans + corn|Brown beef with taco seasoning|Assemble bowls with romaine, salsa, avocado"
      ],
      ["beef-06","Beef meatballs + marinara + kale + orzo","beef","italian","kale","orzo",0,1,1,
        "Kale|1|bag|Produce;Orzo|1|box|Pantry;Marinara|1|jar|Pantry;Parmesan|1|pack|Dairy",
        "Bake or pan-sear meatballs|Cook orzo; warm marinara|Sauté kale; bowl it up"
      ],
      ["beef-07","Steak salad + arugula + cucumber + tomatoes + farro","beef","mediterranean","arugula,cucumbers,tomatoes","farro",0,0,1,
        "Arugula|1|bag|Produce;Cucumber|1|each|Produce;Cherry tomatoes|1|pack|Produce;Cooked farro (10-min)|1|pack|Pantry;Feta|1|pack|Dairy;Lemon|1|each|Produce",
        "Cook farro; cool slightly|Sear steak; slice|Toss salad; top with steak"
      ],
      ["beef-08","Beef + bok choy + carrots + rice noodles","beef","thai","bok choy,carrots","noodles",0,1,1,
        "Bok choy|2|each|Produce;Carrots|1|bag|Produce;Rice noodles|1|pack|Pantry;Soy sauce|1|bottle|Spices/Sauces;Lime|1|each|Produce",
        "Soak noodles|Stir-fry beef + veg|Season soy + lime; serve"
      ],
      ["beef-09","Beef kofta + cabbage salad + couscous","beef","mediterranean","cabbage,cucumbers","couscous",0,1,1,
        "Shredded cabbage mix|1|bag|Produce;Cucumber|1|each|Produce;Couscous|1|box|Pantry;Greek yogurt|1|each|Dairy;Lemon|1|each|Produce;Za'atar|1|each|Spices/Sauces",
        "Pan-sear kofta|Quick cabbage/cucumber yogurt salad|Cook couscous; sprinkle za’atar"
      ],
      ["beef-10","Beef lettuce wraps + mushrooms + water chestnuts","beef","asian","lettuce,mushrooms","none",0,0,1,
        "Butter lettuce|1|each|Produce;Cremini mushrooms|1|pack|Produce;Water chestnuts|1|can|Pantry;Soy sauce|1|bottle|Spices/Sauces;Green onions|1|each|Produce",
        "Brown beef with soy + garlic|Add mushrooms + water chestnuts|Serve in lettuce cups"
      ],
      ["beef-11","Steak + Brussels sprouts + balsamic mushrooms + farro","beef","new american","brussels sprouts,mushrooms","farro",0,0,1,
        "Brussels sprouts|1|bag|Produce;Cremini mushrooms|1|pack|Produce;Cooked farro (10-min)|1|pack|Pantry;Balsamic glaze|1|bottle|Spices/Sauces",
        "Roast Brussels sprouts|Sauté mushrooms; balsamic finish|Sear steak; serve with farro"
      ],
      ["beef-12","Beef shawarma bowls + tomatoes + cucumbers + hummus + rice","beef","middle eastern","tomatoes,cucumbers","rice",0,0,1,
        "Cucumber|1|each|Produce;Tomatoes|2|each|Produce;Hummus|1|each|Deli/Prepared;Jasmine rice|1|bag|Pantry;Shawarma seasoning|1|each|Spices/Sauces;Lemon|1|each|Produce",
        "Sear beef with shawarma seasoning|Cook rice; chop veg|Assemble bowls with hummus + lemon"
      ],

      // Chicken (14)
      ["chicken-01","Grilled chicken + zucchini + couscous + lemon-herb yogurt","chicken","mediterranean","zucchini","couscous",0,1,1,
        "Zucchini|3|each|Produce;Couscous|1|box|Pantry;Greek yogurt|1|each|Dairy;Lemon|1|each|Produce;Dill (or parsley)|1|each|Produce",
        "Cook chicken|Sauté zucchini; cook couscous|Stir yogurt + lemon + herbs; dollop"
      ],
      ["chicken-02","Pesto chicken + cherry tomatoes + spinach + orzo","chicken","italian","tomatoes,spinach","pasta",0,1,1,
        "Cherry tomatoes|1|pack|Produce;Baby spinach|1|bag|Produce;Orzo|1|box|Pantry;Pesto|1|jar|Deli/Prepared;Parmesan|1|pack|Dairy",
        "Cook orzo; toss pesto|Sear chicken; slice|Wilt spinach; warm tomatoes; combine"
      ],
      ["chicken-03","Chicken taco bowls + roasted sweet potatoes + romaine + salsa","chicken","mexican","sweet potatoes,romaine","none",0,0,1,
        "Sweet potatoes|2|each|Produce;Romaine hearts|1|pack|Produce;Salsa|1|jar|Deli/Prepared;Avocados|2|each|Produce;Taco seasoning|1|each|Spices/Sauces",
        "Roast sweet potatoes|Cook chicken with taco seasoning|Build bowls with romaine, salsa, avocado"
      ],
      ["chicken-04","Teriyaki chicken + broccoli + carrots + rice","chicken","japanese","broccoli,carrots","rice",0,0,1,
        "Broccoli florets|1|bag|Produce;Carrots|1|bag|Produce;Jasmine rice|1|bag|Pantry;Teriyaki sauce|1|bottle|Spices/Sauces",
        "Cook rice|Stir-fry chicken + veg|Add light teriyaki; serve"
      ],
      ["chicken-05","Chicken + roasted Brussels sprouts + cauliflower mash","chicken","new american","brussels sprouts,cauliflower","none",0,0,1,
        "Brussels sprouts|1|bag|Produce;Cauliflower florets|1|bag|Frozen;Garlic|1|each|Produce;Butter (or olive oil)|1|each|Dairy",
        "Roast Brussels sprouts|Mash cauliflower with garlic|Pan-sear chicken; serve"
      ],
      ["chicken-06","Quick chicken curry + spinach + cauliflower rice","chicken","indian","spinach,cauliflower","none",0,0,1,
        "Baby spinach|1|bag|Produce;Cauliflower rice|1|bag|Frozen;Coconut milk|1|can|Pantry;Curry powder|1|each|Spices/Sauces;Onion|1|each|Produce",
        "Sauté onion + curry|Simmer chicken in coconut milk|Wilt spinach; serve over cauli rice"
      ],
      ["chicken-07","Chicken shawarma + cucumber-tomato salad + farro","chicken","middle eastern","cucumbers,tomatoes","farro",0,0,1,
        "Cucumber|1|each|Produce;Tomatoes|2|each|Produce;Cooked farro (10-min)|1|pack|Pantry;Shawarma seasoning|1|each|Spices/Sauces;Lemon|1|each|Produce",
        "Cook chicken with shawarma seasoning|Toss cucumber + tomato + lemon|Serve with farro"
      ],
      ["chicken-08","Chicken + mushrooms + green beans + pasta","chicken","new american","mushrooms,green beans","orzo",0,1,1,
        "Green beans|1|bag|Produce;Cremini mushrooms|1|pack|Produce;Orzo|1|box|Pantry;Garlic|1|each|Produce;Butter|1|each|Dairy",
        "Cook orzo; stir in garlic butter|Sear chicken|Sauté mushrooms + green beans; plate"
      ],
      ["chicken-09","Chicken stir-fry + bok choy + peppers + rice noodles","chicken","thai","bok choy,peppers","noodles",0,1,1,
        "Bok choy|2|each|Produce;Bell peppers|2|each|Produce;Rice noodles|1|pack|Pantry;Soy sauce|1|bottle|Spices/Sauces;Lime|1|each|Produce",
        "Soak noodles|Stir-fry chicken + veg|Sauce soy + lime; serve"
      ],
      ["chicken-10","Harissa chicken + roasted eggplant + couscous","chicken","north african","eggplant","couscous",0,1,1,
        "Eggplant|1|each|Produce;Couscous|1|box|Pantry;Harissa paste|1|jar|Spices/Sauces;Lemon|1|each|Produce",
        "Roast eggplant cubes|Cook chicken with harissa|Cook couscous; finish lemon"
      ],
      ["chicken-11","Chicken + roasted carrots + asparagus + farro","chicken","new american","carrots,asparagus","farro",0,0,1,
        "Carrots|1|bag|Produce;Asparagus|1|each|Produce;Cooked farro (10-min)|1|pack|Pantry;Lemon|1|each|Produce",
        "Roast carrots; add asparagus|Cook chicken with lemon/pepper|Serve with farro"
      ],
      ["chicken-12","Chicken lettuce wraps + cucumbers + carrots + peanut sauce","chicken","asian","lettuce,cucumbers,carrots","none",0,0,1,
        "Butter lettuce|1|each|Produce;Cucumber|1|each|Produce;Carrots|1|bag|Produce;Peanut butter|1|jar|Pantry;Soy sauce|1|bottle|Spices/Sauces;Lime|1|each|Produce",
        "Cook chicken; chop|Mix peanut sauce (PB+soy+lime+water)|Serve in lettuce cups with veg"
      ],
      ["chicken-13","Chicken + roasted cabbage wedges + carrots + rice","chicken","new american","cabbage,carrots","rice",0,0,1,
        "Cabbage|1|each|Produce;Carrots|1|bag|Produce;Rice|1|bag|Pantry",
        "Roast cabbage wedges + carrots|Cook rice|Pan-sear chicken; serve"
      ],
      ["chicken-14","Chicken + roasted cauliflower + peppers + rice","chicken","new american","cauliflower,peppers","rice",0,0,1,
        "Cauliflower florets|1|bag|Produce;Bell peppers|2|each|Produce;Rice|1|bag|Pantry",
        "Roast cauliflower + peppers|Cook rice|Cook chicken; serve"
      ],

      // Turkey (12)
      ["turkey-01","Turkey meatballs + sweet potatoes + green beans","turkey","new american","sweet potatoes,green beans","none",0,0,1,
        "Sweet potatoes|2|each|Produce;Green beans|1|bag|Produce;Italian seasoning|1|each|Spices/Sauces",
        "Roast sweet potatoes|Bake/pan-sear turkey meatballs|Sauté green beans"
      ],
      ["turkey-02","Turkey taco bowls + cabbage slaw + black beans + rice","turkey","mexican","cabbage","rice",0,0,1,
        "Shredded cabbage mix|1|bag|Produce;Black beans|2|can|Pantry;Brown rice|1|bag|Pantry;Taco seasoning|1|each|Spices/Sauces;Lime|1|each|Produce",
        "Cook rice; warm beans|Brown turkey with taco seasoning|Slaw: cabbage + lime; assemble"
      ],
      ["turkey-03","Turkey burgers (no bun default) + mushrooms + asparagus","turkey","american","mushrooms,asparagus","none",0,0,1,
        "Cremini mushrooms|1|pack|Produce;Asparagus|1|each|Produce;Mustard|1|each|Spices/Sauces",
        "Pan-sear patties|Sauté mushrooms; roast asparagus|Serve (bun optional)"
      ],
      ["turkey-04","Turkey skillet + zucchini + peppers + pasta","turkey","mediterranean","zucchini,peppers","orzo",0,1,1,
        "Zucchini|2|each|Produce;Bell peppers|2|each|Produce;Orzo|1|box|Pantry;Garlic|1|each|Produce",
        "Cook orzo|Brown turkey|Add veg + garlic; serve over orzo"
      ],
      ["turkey-05","Turkey chili + tomatoes + peppers + side salad","turkey","tex-mex","tomatoes,peppers","none",0,0,1,
        "Diced tomatoes|2|can|Pantry;Bell pepper|1|each|Produce;Kidney beans|2|can|Pantry;Chili powder|1|each|Spices/Sauces;Mixed greens|1|bag|Produce",
        "Brown turkey + pepper|Simmer with tomatoes + beans|Serve with salad"
      ],
      ["turkey-06","Turkey meat sauce + spinach + pasta (or lentil pasta)","turkey","italian","spinach","pasta",0,1,1,
        "Baby spinach|1|bag|Produce;Marinara|1|jar|Pantry;Spaghetti (or lentil pasta)|1|box|Pantry;Parmesan|1|pack|Dairy",
        "Brown turkey; add marinara|Cook pasta|Wilt spinach into sauce; serve"
      ],
      ["turkey-07","Turkey lettuce wraps + cucumbers + carrots + rice","turkey","asian","lettuce,cucumbers,carrots","rice",0,0,1,
        "Butter lettuce|1|each|Produce;Cucumber|1|each|Produce;Carrots|1|bag|Produce;Jasmine rice|1|bag|Pantry;Soy sauce|1|bottle|Spices/Sauces",
        "Cook rice|Brown turkey with soy + garlic|Serve in lettuce; rice on side"
      ],
      ["turkey-08","Turkey meatballs + pesto + roasted zucchini + farro","turkey","italian","zucchini","farro",0,0,1,
        "Zucchini|2|each|Produce;Cooked farro (10-min)|1|pack|Pantry;Pesto|1|jar|Deli/Prepared;Parmesan|1|pack|Dairy",
        "Roast zucchini|Cook meatballs|Toss farro with pesto; top"
      ],
      ["turkey-09","Turkey + roasted cauliflower + green beans + rice","turkey","new american","cauliflower,green beans","rice",0,0,1,
        "Cauliflower florets|1|bag|Produce;Green beans|1|bag|Produce;Rice|1|bag|Pantry",
        "Roast cauliflower|Sauté green beans|Brown turkey; serve with rice"
      ],
      ["turkey-10","Turkey kofta + roasted carrots + cucumber yogurt + couscous","turkey","middle eastern","carrots,cucumbers","couscous",0,1,1,
        "Carrots|1|bag|Produce;Cucumber|1|each|Produce;Greek yogurt|1|each|Dairy;Couscous|1|box|Pantry;Cumin|1|each|Spices/Sauces",
        "Roast carrots|Pan-sear kofta|Mix yogurt+cucumber; serve with couscous"
      ],
      ["turkey-11","Turkey “fried rice” + cauliflower rice + peas & carrots","turkey","chinese","cauliflower,carrots,peas","none",0,0,1,
        "Cauliflower rice|1|bag|Frozen;Frozen peas & carrots|1|bag|Frozen;Eggs|4|each|Dairy;Soy sauce|1|bottle|Spices/Sauces;Green onions|1|each|Produce",
        "Brown turkey|Scramble eggs; add cauli rice + peas/carrots|Season soy; top green onion"
      ],
      ["turkey-12","Turkey bolognese + mushrooms + orzo","turkey","italian","mushrooms","orzo",0,1,1,
        "Cremini mushrooms|1|pack|Produce;Marinara|1|jar|Pantry;Orzo|1|box|Pantry",
        "Cook orzo|Sauté mushrooms; brown turkey; add marinara|Serve over orzo"
      ],

      // Sausage (12)
      ["saus-01","Sausage + peppers + onions + roasted potatoes","sausage","italian","peppers,onions","potatoes",1,0,1,
        "Bell peppers|2|each|Produce;Onion|1|each|Produce;Baby potatoes|1|bag|Produce",
        "Roast potatoes|Brown sausage; sauté peppers+onions|Combine and serve"
      ],
      ["saus-02","Sausage + kale + white beans + lemon (one-pan)","sausage","new american","kale","none",1,0,1,
        "Kale|1|bag|Produce;Cannellini beans|2|can|Pantry;Garlic|1|each|Produce;Lemon|1|each|Produce",
        "Brown sausage|Sauté garlic+kale; add beans|Return sausage; finish lemon"
      ],
      ["saus-03","Sausage + Brussels sprouts + farro + mustard vinaigrette","sausage","new american","brussels sprouts","farro",1,0,1,
        "Brussels sprouts|1|bag|Produce;Cooked farro (10-min)|1|pack|Pantry;Dijon mustard|1|each|Spices/Sauces;Apple cider vinegar|1|bottle|Spices/Sauces",
        "Roast Brussels sprouts|Brown sausage slices|Toss farro with Dijon + vinegar"
      ],
      ["saus-04","Sausage + zucchini + marinara + pasta","sausage","italian","zucchini","orzo",1,1,1,
        "Zucchini|2|each|Produce;Marinara|1|jar|Pantry;Orzo|1|box|Pantry",
        "Cook orzo|Brown sausage; add zucchini|Add marinara; serve"
      ],
      ["saus-05","Sausage & cabbage stir-fry + carrots + rice","sausage","asian","cabbage,carrots","rice",1,0,1,
        "Cabbage|1|each|Produce;Carrots|1|bag|Produce;Rice|1|bag|Pantry;Soy sauce|1|bottle|Spices/Sauces",
        "Cook rice|Brown sausage|Add cabbage+carrots; season soy"
      ],
      ["saus-06","Sausage + spinach + tomatoes + polenta","sausage","italian","spinach,tomatoes","polenta",1,0,1,
        "Baby spinach|1|bag|Produce;Cherry tomatoes|1|pack|Produce;Polenta (tube)|1|pack|Deli/Prepared",
        "Brown sausage|Sauté tomatoes; wilt spinach|Pan-crisp polenta; top"
      ],
      ["saus-07","Sausage sheet-pan + cauliflower + broccoli + potatoes","sausage","new american","cauliflower,broccoli","potatoes",1,0,1,
        "Cauliflower florets|1|bag|Produce;Broccoli florets|1|bag|Produce;Baby potatoes|1|bag|Produce",
        "Roast potatoes|Add sausage+veg; roast until browned|Serve"
      ],
      ["saus-08","Sausage + mushrooms + green beans + rice","sausage","new american","mushrooms,green beans","rice",1,0,1,
        "Cremini mushrooms|1|pack|Produce;Green beans|1|bag|Produce;Rice|1|bag|Pantry",
        "Cook rice|Brown sausage|Sauté mushrooms+green beans; serve"
      ],
      ["saus-09","Sausage + eggplant + tomatoes + couscous","sausage","mediterranean","eggplant,tomatoes","couscous",1,1,1,
        "Eggplant|1|each|Produce;Tomatoes|2|each|Produce;Couscous|1|box|Pantry",
        "Roast eggplant cubes|Brown sausage; add tomatoes|Serve over couscous"
      ],
      ["saus-10","Sausage + roasted carrots + Brussels sprouts + farro","sausage","new american","carrots,brussels sprouts","farro",1,0,1,
        "Carrots|1|bag|Produce;Brussels sprouts|1|bag|Produce;Cooked farro (10-min)|1|pack|Pantry",
        "Roast carrots + Brussels sprouts|Brown sausage slices|Serve with farro"
      ],
      ["saus-11","Sausage tacos + peppers + onions + tortillas","sausage","tex-mex","peppers,onions","tortillas",1,1,1,
        "Bell peppers|2|each|Produce;Onion|1|each|Produce;Corn tortillas|1|pack|Bakery;Salsa|1|jar|Deli/Prepared",
        "Sauté peppers+onions; brown sausage|Warm tortillas|Assemble with salsa"
      ],
      ["saus-12","Sausage + spinach + chickpeas + lemon (one-pan)","sausage","mediterranean","spinach","none",1,0,1,
        "Baby spinach|1|bag|Produce;Chickpeas|2|can|Pantry;Lemon|1|each|Produce;Garlic|1|each|Produce",
        "Brown sausage|Sauté garlic; add chickpeas + spinach|Finish lemon; serve"
      ],

      // Pork (12)
      ["pork-01","Pork chops + roasted Brussels sprouts + sweet potatoes","pork","new american","brussels sprouts,sweet potatoes","none",0,0,1,
        "Brussels sprouts|1|bag|Produce;Sweet potatoes|2|each|Produce;Apple cider vinegar|1|bottle|Spices/Sauces",
        "Roast sprouts + sweet potatoes|Pan-sear pork chops|Splash sprouts with cider vinegar"
      ],
      ["pork-02","Pork stir-fry + bok choy + mushrooms + rice","pork","chinese","bok choy,mushrooms","rice",0,0,1,
        "Bok choy|2|each|Produce;Cremini mushrooms|1|pack|Produce;Rice|1|bag|Pantry;Soy sauce|1|bottle|Spices/Sauces;Ginger|1|each|Produce",
        "Cook rice|Stir-fry pork + ginger; add veg|Season soy; serve"
      ],
      ["pork-03","Pork carnitas bowls + cabbage + pico + rice","pork","mexican","cabbage,tomatoes","rice",0,0,1,
        "Shredded cabbage mix|1|bag|Produce;Tomatoes|2|each|Produce;Cilantro|1|each|Produce;Lime|1|each|Produce;Rice|1|bag|Pantry",
        "Cook rice|Cook pork carnitas-style|Top with cabbage + pico (tomato/cilantro/lime)"
      ],
      ["pork-04","Pork + roasted cauliflower + green beans + farro","pork","new american","cauliflower,green beans","farro",0,0,1,
        "Cauliflower florets|1|bag|Produce;Green beans|1|bag|Produce;Cooked farro (10-min)|1|pack|Pantry",
        "Roast cauliflower|Sauté green beans|Pan-sear pork; serve with farro"
      ],
      ["pork-05","Pork tenderloin + spinach + tomatoes + couscous","pork","mediterranean","spinach,tomatoes","couscous",0,1,1,
        "Baby spinach|1|bag|Produce;Cherry tomatoes|1|pack|Produce;Couscous|1|box|Pantry;Lemon|1|each|Produce",
        "Cook couscous|Sear pork; slice|Sauté tomatoes; wilt spinach; finish lemon"
      ],
      ["pork-06","Pork + roasted carrots + asparagus + rice","pork","new american","carrots,asparagus","rice",0,0,1,
        "Carrots|1|bag|Produce;Asparagus|1|each|Produce;Rice|1|bag|Pantry",
        "Roast carrots; add asparagus|Cook rice|Pan-sear pork; serve"
      ],
      ["pork-07","Pork lettuce wraps + cucumbers + carrots + lime","pork","asian","lettuce,cucumbers,carrots","none",0,0,1,
        "Butter lettuce|1|each|Produce;Cucumber|1|each|Produce;Carrots|1|bag|Produce;Lime|1|each|Produce;Soy sauce|1|bottle|Spices/Sauces",
        "Cook pork with soy|Serve in lettuce cups with veg|Squeeze lime"
      ],
      ["pork-08","Pork + mushrooms + cabbage + rice noodles","pork","thai","mushrooms,cabbage","noodles",0,1,1,
        "Cabbage|1|each|Produce;Cremini mushrooms|1|pack|Produce;Rice noodles|1|pack|Pantry;Lime|1|each|Produce;Soy sauce|1|bottle|Spices/Sauces",
        "Soak noodles|Stir-fry pork + mushrooms + cabbage|Season soy + lime; serve"
      ],
      ["pork-09","Pork + roasted eggplant + tomatoes + couscous","pork","mediterranean","eggplant,tomatoes","couscous",0,1,1,
        "Eggplant|1|each|Produce;Tomatoes|2|each|Produce;Couscous|1|box|Pantry",
        "Roast eggplant cubes|Cook couscous|Cook pork; simmer tomatoes; combine"
      ],
      ["pork-10","Pork + roasted Brussels sprouts + cauliflower mash","pork","new american","brussels sprouts,cauliflower","none",0,0,1,
        "Brussels sprouts|1|bag|Produce;Cauliflower florets|1|bag|Frozen;Butter|1|each|Dairy",
        "Roast Brussels sprouts|Mash cauliflower|Pan-sear pork; serve"
      ],
      ["pork-11","Pork + kale + mushrooms + farro","pork","new american","kale,mushrooms","farro",0,0,1,
        "Kale|1|bag|Produce;Cremini mushrooms|1|pack|Produce;Cooked farro (10-min)|1|pack|Pantry",
        "Cook farro|Sauté kale + mushrooms|Pan-sear pork; serve"
      ],
      ["pork-12","Pork tacos + peppers + onions + tortillas","pork","mexican","peppers,onions","tortillas",0,1,1,
        "Bell peppers|2|each|Produce;Onion|1|each|Produce;Corn tortillas|1|pack|Bakery;Salsa|1|jar|Deli/Prepared;Cilantro|1|each|Produce;Lime|1|each|Produce",
        "Cook pork with taco spices|Sauté peppers+onions|Warm tortillas; assemble"
      ],

      // Salmon (12)
      ["salmon-01","Salmon + zucchini + couscous + lemon-dill","salmon","mediterranean","zucchini","couscous",0,1,1,
        "Zucchini|2|each|Produce;Couscous|1|box|Pantry;Lemon|1|each|Produce;Dill|1|each|Produce",
        "Cook salmon|Sauté zucchini; cook couscous|Finish with lemon + dill"
      ],
      ["salmon-02","Miso salmon + bok choy + mushrooms + rice","salmon","japanese","bok choy,mushrooms","rice",0,0,1,
        "Bok choy|2|each|Produce;Cremini mushrooms|1|pack|Produce;Rice|1|bag|Pantry;Miso paste|1|each|Spices/Sauces;Soy sauce|1|bottle|Spices/Sauces",
        "Bake salmon with miso+soy glaze|Sauté bok choy+mushrooms|Serve with rice"
      ],
      ["salmon-03","Salmon + roasted Brussels sprouts + sweet potatoes","salmon","new american","brussels sprouts,sweet potatoes","none",0,0,1,
        "Brussels sprouts|1|bag|Produce;Sweet potatoes|2|each|Produce;Lemon|1|each|Produce",
        "Roast sprouts + sweet potatoes|Bake salmon|Squeeze lemon"
      ],
      ["salmon-04","Salmon bowls + spinach + cucumber + avocado + rice","salmon","fusion","spinach,cucumbers,avocado","rice",0,0,1,
        "Baby spinach|1|bag|Produce;Cucumber|1|each|Produce;Avocados|2|each|Produce;Rice|1|bag|Pantry;Sesame seeds|1|each|Spices/Sauces",
        "Cook rice|Cook salmon; flake|Bowl with spinach, cucumber, avocado; sesame"
      ],
      ["salmon-05","Salmon + asparagus + farro + lemon-dill","salmon","mediterranean","asparagus","farro",0,0,1,
        "Asparagus|1|each|Produce;Cooked farro (10-min)|1|pack|Pantry;Lemon|1|each|Produce;Dill|1|each|Produce",
        "Cook farro|Roast asparagus; cook salmon|Finish lemon + dill"
      ],
      ["salmon-06","Salmon + cauliflower + green beans + rice","salmon","new american","cauliflower,green beans","rice",0,0,1,
        "Cauliflower florets|1|bag|Produce;Green beans|1|bag|Produce;Rice|1|bag|Pantry",
        "Roast cauliflower|Sauté green beans|Cook salmon; serve with rice"
      ],
      ["salmon-07","Salmon tacos + cabbage slaw + avocado + tortillas","salmon","mexican","cabbage,avocado","tortillas",0,1,1,
        "Shredded cabbage mix|1|bag|Produce;Avocados|2|each|Produce;Corn tortillas|1|pack|Bakery;Lime|1|each|Produce;Greek yogurt|1|each|Dairy",
        "Cook salmon; flake|Slaw: cabbage + lime + yogurt|Warm tortillas; assemble"
      ],
      ["salmon-08","Mediterranean salmon + roasted eggplant + tomatoes + couscous","salmon","mediterranean","eggplant,tomatoes","couscous",0,1,1,
        "Eggplant|1|each|Produce;Tomatoes|2|each|Produce;Couscous|1|box|Pantry",
        "Roast eggplant + tomatoes|Cook salmon|Cook couscous; serve"
      ],
      ["salmon-09","Spicy salmon bowls + carrots + cucumbers + cauliflower rice","salmon","fusion","carrots,cucumbers,cauliflower","none",0,0,1,
        "Carrots|1|bag|Produce;Cucumber|1|each|Produce;Cauliflower rice|1|bag|Frozen;Sriracha|1|bottle|Spices/Sauces;Greek yogurt|1|each|Dairy",
        "Cook cauliflower rice|Cook salmon|Drizzle yogurt+sriracha; add carrots+cucumber"
      ],
      ["salmon-10","Salmon + spinach + mushrooms + orzo","salmon","italian","spinach,mushrooms","orzo",0,1,1,
        "Baby spinach|1|bag|Produce;Cremini mushrooms|1|pack|Produce;Orzo|1|box|Pantry;Lemon|1|each|Produce",
        "Cook orzo|Sauté mushrooms; wilt spinach|Cook salmon; finish lemon; serve"
      ],
      ["salmon-11","Salmon + roasted peppers + zucchini + farro","salmon","mediterranean","peppers,zucchini","farro",0,0,1,
        "Bell peppers|2|each|Produce;Zucchini|2|each|Produce;Cooked farro (10-min)|1|pack|Pantry",
        "Roast peppers+zucchini|Cook salmon|Serve with farro"
      ],
      ["salmon-12","Salmon + roasted cauliflower + cucumber salad + rice","salmon","new american","cauliflower,cucumbers","rice",0,0,1,
        "Cauliflower florets|1|bag|Produce;Cucumber|1|each|Produce;Rice|1|bag|Pantry;Rice vinegar|1|bottle|Spices/Sauces",
        "Roast cauliflower|Cook rice|Cucumber salad with vinegar|Cook salmon; serve"
      ],

      // Shrimp (12)
      ["shrimp-01","Shrimp + zucchini + garlic + pasta","shrimp","italian","zucchini","orzo",0,1,1,
        "Zucchini|2|each|Produce;Orzo|1|box|Pantry;Garlic|1|each|Produce;Lemon|1|each|Produce",
        "Cook orzo|Sauté zucchini+garlic; add shrimp 3–4 min|Finish lemon; toss"
      ],
      ["shrimp-02","Shrimp tacos + cabbage slaw + avocado + tortillas","shrimp","mexican","cabbage,avocado","tortillas",0,1,1,
        "Shredded cabbage mix|1|bag|Produce;Avocados|2|each|Produce;Corn tortillas|1|pack|Bakery;Limes|2|each|Produce;Greek yogurt|1|each|Dairy",
        "Cook shrimp with chili+lime|Slaw: cabbage + lime + yogurt|Warm tortillas; assemble"
      ],
      ["shrimp-03","Shrimp stir-fry + bok choy + mushrooms + rice","shrimp","chinese","bok choy,mushrooms","rice",0,0,1,
        "Bok choy|2|each|Produce;Cremini mushrooms|1|pack|Produce;Rice|1|bag|Pantry;Soy sauce|1|bottle|Spices/Sauces;Ginger|1|each|Produce",
        "Cook rice|Stir-fry mushrooms+bok choy|Add shrimp; season soy+ginger"
      ],
      ["shrimp-04","Shrimp + roasted asparagus + farro + lemon","shrimp","mediterranean","asparagus","farro",0,0,1,
        "Asparagus|1|each|Produce;Cooked farro (10-min)|1|pack|Pantry;Lemon|1|each|Produce",
        "Roast asparagus|Sauté shrimp quickly|Serve with farro + lemon"
      ],
      ["shrimp-05","Shrimp curry + spinach + cauliflower rice","shrimp","thai","spinach,cauliflower","none",0,0,1,
        "Baby spinach|1|bag|Produce;Cauliflower rice|1|bag|Frozen;Coconut milk|1|can|Pantry;Red curry paste|1|jar|Spices/Sauces",
        "Simmer coconut milk + curry paste|Add shrimp 3–4 min; wilt spinach|Serve over cauli rice"
      ],
      ["shrimp-06","Shrimp + roasted Brussels sprouts + sweet potatoes","shrimp","new american","brussels sprouts,sweet potatoes","none",0,0,1,
        "Brussels sprouts|1|bag|Produce;Sweet potatoes|2|each|Produce",
        "Roast sprouts + sweet potatoes|Quick-sauté shrimp|Serve"
      ],
      ["shrimp-07","Shrimp bowls + cucumbers + carrots + rice noodles + lime","shrimp","vietnamese","cucumbers,carrots","noodles",0,1,1,
        "Cucumber|1|each|Produce;Carrots|1|bag|Produce;Rice noodles|1|pack|Pantry;Limes|2|each|Produce;Fish sauce (optional)|1|bottle|Spices/Sauces",
        "Soak noodles|Cook shrimp|Quick lime dressing; bowl with cucumber+carrot"
      ],
      ["shrimp-08","Shrimp + roasted cauliflower + green beans + rice","shrimp","new american","cauliflower,green beans","rice",0,0,1,
        "Cauliflower florets|1|bag|Produce;Green beans|1|bag|Produce;Rice|1|bag|Pantry",
        "Roast cauliflower|Sauté green beans|Cook shrimp; serve with rice"
      ],
      ["shrimp-09","Shrimp + mushrooms + spinach + couscous","shrimp","mediterranean","mushrooms,spinach","couscous",0,1,1,
        "Cremini mushrooms|1|pack|Produce;Baby spinach|1|bag|Produce;Couscous|1|box|Pantry;Lemon|1|each|Produce",
        "Cook couscous|Sauté mushrooms; add shrimp|Wilt spinach; finish lemon; serve"
      ],
      ["shrimp-10","Shrimp fajita bowls + peppers + onions + rice","shrimp","mexican","peppers,onions","rice",0,0,1,
        "Bell peppers|2|each|Produce;Onion|1|each|Produce;Rice|1|bag|Pantry;Fajita seasoning|1|each|Spices/Sauces;Lime|1|each|Produce",
        "Cook rice|Sauté peppers+onions|Add shrimp + seasoning; finish lime"
      ],
      ["shrimp-11","Shrimp + roasted eggplant + tomatoes + farro","shrimp","mediterranean","eggplant,tomatoes","farro",0,0,1,
        "Eggplant|1|each|Produce;Tomatoes|2|each|Produce;Cooked farro (10-min)|1|pack|Pantry",
        "Roast eggplant+tomatoes|Sauté shrimp quickly|Serve with farro"
      ],
      ["shrimp-12","Shrimp + roasted mushrooms + spinach + farro","shrimp","new american","mushrooms,spinach","farro",0,0,1,
        "Cremini mushrooms|1|pack|Produce;Baby spinach|1|bag|Produce;Cooked farro (10-min)|1|pack|Pantry",
        "Roast mushrooms|Cook shrimp; wilt spinach|Serve with farro"
      ],
    ];

    /**********************
     * Helpers
     **********************/
    const proteinOrder = ["beef","chicken","turkey","sausage","pork","salmon","shrimp"];
    const aisleOrder = ["Produce","Frozen","Meat/Seafood","Dairy","Pantry","Bakery","Deli/Prepared","Spices/Sauces","Other"];

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function nowISO(){ return new Date().toISOString(); }
    function daysAgoISO(days){
      const d = new Date();
      d.setDate(d.getDate()-days);
      return d.toISOString();
    }
    function normalize(s){
      return (s||"")
        .toLowerCase()
        .replace(/[’']/g,"")
        .replace(/[^a-z0-9\s]/g," ")
        .replace(/\s+/g," ")
        .trim();
    }
    function splitCSV(s){ return (s||"").split(",").map(x=>x.trim()).filter(Boolean); }

    function parseIngredients(str){
      // "Name|qty|unit|aisle;Name2|qty|unit|aisle"
      if(!str) return [];
      return str.split(";").map(seg => {
        const [name, qty, unit, aisle] = seg.split("|").map(x => (x||"").trim());
        return {
          id: normalize(name || "") || uid(),
          name: name || "",
          qty: Number(qty || 1),
          unit: unit || "each",
          aisle: aisle || "Other",
        };
      }).filter(x => x.name);
    }

    function parseSteps(str){
      if(!str) return [];
      return str.split("|").map(x=>x.trim()).filter(Boolean);
    }

    function mealFromRow(r){
      const [id,name,protein,cuisine,vegCSV,sideCSV,processed,refined,vegForward,ingredientsStr,stepsStr] = r;
      return {
        id, name, protein, cuisine,
        vegTags: splitCSV(vegCSV),
        sideTags: splitCSV(sideCSV),
        processed: !!processed,
        refinedCarb: !!refined,
        vegForward: !!vegForward,
        ingredients: parseIngredients(ingredientsStr),
        steps: parseSteps(stepsStr),
      };
    }

    const MEALS = MEAL_ROWS.map(mealFromRow);
    const MEAL_BY_ID = new Map(MEALS.map(m => [m.id, m]));

    function safeLoad(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        console.warn("Load failed", e);
        return null;
      }
    }
    function safeSave(obj){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      }catch(e){
        console.warn("Save failed", e);
      }
    }

    function defaultState(){
      return {
        version: 26,
        settings: {
          dinnerNights: 5,
          leftoverNights: 1,
          avoidDays: 10,
          healthyMode: true,
          maxProcessed: 2,
          maxRefined: 3,
          vegForwardBias: 2,
          penalizeUnhealthy: 2,
          // Portion math (oz/person)
          ozMale: 8,
          ozFemale: 6
        },
        inventory: {
          beef: 6, chicken: 8, turkey: 5, sausage: 4, pork: 6, salmon: 4, shrimp: 3
        },
        pantry: ["olive oil","salt","pepper","garlic","onion","rice","soy sauce"],
        staples: ["mixed greens","lemons","avocados"],
        snacks: ["popcorn","chocolate"],
        history: [], // {mealId, atISO}
        plan: null,  // {weekId, generatedAtISO, dinners:[{id, mealId, status, removed:[], notes?}], dinnersCount, leftoversCount}
      };
    }

    /**********************
     * Pantry fuzzy matching
     **********************/
    function pantryCoversIngredient(pantryList, ingredientName){
      const ing = normalize(ingredientName);
      if(!ing) return false;
      for(const p of pantryList){
        const pn = normalize(p);
        if(!pn) continue;
        // fuzzy: either substring match direction
        if(ing.includes(pn) || pn.includes(ing)) return true;
      }
      return false;
    }

    /**********************
     * Scoring / selection
     **********************/
    function computeProteinLbsPerDinner(settings){
      const totalOz = Number(settings.ozMale||0) + Number(settings.ozFemale||0);
      // ounces -> pounds
      return totalOz / 16;
    }

    function getRecentMealSet(history, avoidDays){
      const cutoff = new Date(daysAgoISO(avoidDays)).getTime();
      const set = new Set();
      for(const h of history){
        const t = new Date(h.atISO).getTime();
        if(t >= cutoff) set.add(h.mealId);
      }
      return set;
    }

    function scoreMeal(meal, ctx){
      // ctx: {usedVegCount, usedCuisineCount, lastProtein, inventory, proteinLbsNeeded, settings}
      const s = ctx.settings;
      let score = 0;

      // Inventory preference
      const inv = Number(ctx.inventory[meal.protein] || 0);
      if(inv >= ctx.proteinLbsNeeded) score += 8;
      else score -= 12;

      // Protein streak penalty
      if(ctx.lastProtein && ctx.lastProtein === meal.protein) score -= 8;

      // Veg variety
      for(const v of meal.vegTags){
        const c = ctx.usedVegCount.get(v) || 0;
        if(c === 0) score += 4;
        else if(c === 1) score += 1;
        else score -= 3;
      }

      // Cuisine variety
      const cc = ctx.usedCuisineCount.get(meal.cuisine) || 0;
      if(cc === 0) score += 4;
      else if(cc === 1) score += 1;
      else score -= 3;

      // Healthy mode tuning
      if(s.healthyMode){
        if(meal.vegForward) score += (2 + Number(s.vegForwardBias||0));
        if(meal.processed) score -= (3 + Number(s.penalizeUnhealthy||0));
        if(meal.refinedCarb) score -= (2 + Math.floor(Number(s.penalizeUnhealthy||0)/2));
      }

      // Small randomness so it's not identical
      score += (Math.random() * 0.7);

      return score;
    }

    function generatePlan(state){
      const settings = state.settings;
      const dinnersCount = clamp(Number(settings.dinnerNights||0), 0, 7);
      const leftoversCount = clamp(Number(settings.leftoverNights||0), 0, 7);
      const cookCount = clamp(dinnersCount - leftoversCount, 0, 7);

      const recentSet = getRecentMealSet(state.history, Number(settings.avoidDays||0));

      // Filter candidates: no recent meals
      const candidates = MEALS.filter(m => !recentSet.has(m.id));

      const proteinLbsNeeded = computeProteinLbsPerDinner(settings);

      const usedVegCount = new Map();
      const usedCuisineCount = new Map();
      let lastProtein = null;

      let processedUsed = 0;
      let refinedUsed = 0;

      const dinners = [];

      // We'll fill cookCount slots with meals, and leftover slots with placeholder entries.
      for(let i=0;i<cookCount;i++){
        // compute best meal under constraints
        const scored = [];
        for(const meal of candidates){
          // prevent repeats in-week
          if(dinners.some(d => d.mealId === meal.id)) continue;

          // Healthy caps are hard constraints
          if(settings.healthyMode){
            if(meal.processed && processedUsed >= settings.maxProcessed) continue;
            if(meal.refinedCarb && refinedUsed >= settings.maxRefined) continue;
          }

          scored.push([scoreMeal(meal, {usedVegCount, usedCuisineCount, lastProtein, inventory: state.inventory, proteinLbsNeeded, settings}), meal]);
        }

        scored.sort((a,b)=>b[0]-a[0]);
        const pick = scored.length ? scored[0][1] : null;

        if(!pick){
          // fallback: allow recent meals if we ran out
          const fallback = MEALS.filter(m => !dinners.some(d=>d.mealId===m.id));
          fallback.sort((a,b)=> scoreMeal(b,{usedVegCount, usedCuisineCount, lastProtein, inventory: state.inventory, proteinLbsNeeded, settings})
                              - scoreMeal(a,{usedVegCount, usedCuisineCount, lastProtein, inventory: state.inventory, proteinLbsNeeded, settings}));
          if(!fallback.length) break;
          dinners.push({ id: uid(), mealId: fallback[0].id, status:"planned", removed:[] });
        } else {
          dinners.push({ id: uid(), mealId: pick.id, status:"planned", removed:[] });

          // update counters
          for(const v of pick.vegTags) usedVegCount.set(v, (usedVegCount.get(v)||0)+1);
          usedCuisineCount.set(pick.cuisine, (usedCuisineCount.get(pick.cuisine)||0)+1);
          lastProtein = pick.protein;

          if(settings.healthyMode){
            if(pick.processed) processedUsed++;
            if(pick.refinedCarb) refinedUsed++;
          }
        }
      }

      // Add leftover placeholders
      for(let i=0;i<leftoversCount;i++){
        dinners.push({ id: uid(), mealId: null, status:"leftover", removed:[] });
      }

      // Shuffle to spread leftovers around a bit (but keep stable-ish)
      // Simple: interleave leftovers every ~2 meals
      const cooked = dinners.filter(d=>d.status!=="leftover");
      const leftovers = dinners.filter(d=>d.status==="leftover");
      const final = [];
      let li = 0;
      for(let ci=0; ci<cooked.length; ci++){
        final.push(cooked[ci]);
        if((ci % 2 === 1) && li < leftovers.length){
          final.push(leftovers[li++]);
        }
      }
      while(li < leftovers.length) final.push(leftovers[li++]);

      return {
        weekId: new Date().toISOString().slice(0,10),
        generatedAtISO: nowISO(),
        dinnersCount,
        leftoversCount,
        dinners: final,
      };
    }

    /**********************
     * Grocery list builder (with per-plan ingredient exclusions)
     **********************/
    function buildGrocery(state){
      const plan = state.plan;
      if(!plan) return {aisles:new Map(), flat:[]};

      const pantry = state.pantry || [];
      const staples = state.staples || [];
      const snacks = state.snacks || [];

      // Map for summing items: key = normalize(name) + unit + aisle
      const map = new Map();

      function addItem(item){
        const k = `${normalize(item.name)}|${normalize(item.unit)}|${normalize(item.aisle)}`;
        const prev = map.get(k);
        if(prev){
          prev.qty += item.qty;
        } else {
          map.set(k, {...item});
        }
      }

      // Add meal ingredients for planned meals (not leftovers)
      for(const d of plan.dinners){
        if(d.status === "leftover") continue;
        if(!d.mealId) continue;
        const meal = MEAL_BY_ID.get(d.mealId);
        if(!meal) continue;

        const removedSet = new Set((d.removed||[]).map(normalize));

        for(const ing of meal.ingredients){
          // if user excluded it for this dinner, skip
          if(removedSet.has(normalize(ing.name)) || removedSet.has(normalize(ing.id))) continue;

          // pantry fuzzy remove
          if(pantryCoversIngredient(pantry, ing.name)) continue;

          addItem({...ing});
        }
      }

      // Add staples (1 each) unless pantry covers
      for(const s of staples){
        if(!s) continue;
        if(pantryCoversIngredient(pantry, s)) continue;
        addItem({name:s, qty:1, unit:"each", aisle: guessAisle(s)});
      }

      // Add snacks (1 each) unless pantry covers
      for(const sn of snacks){
        if(!sn) continue;
        if(pantryCoversIngredient(pantry, sn)) continue;
        addItem({name:sn, qty:1, unit:"each", aisle: guessAisle(sn)});
      }

      const flat = Array.from(map.values()).map(x => ({
        ...x,
        qty: roundQty(x.qty),
        aisle: x.aisle || "Other"
      }));

      // Group by aisle
      const aisles = new Map();
      for(const it of flat){
        const a = it.aisle || "Other";
        if(!aisles.has(a)) aisles.set(a, []);
        aisles.get(a).push(it);
      }
      for(const [a, items] of aisles){
        items.sort((x,y)=> normalize(x.name).localeCompare(normalize(y.name)));
      }

      return {aisles, flat};
    }

    function roundQty(q){
      // Keep it friendly: integers stay ints; otherwise 1 decimal
      if(Number.isInteger(q)) return q;
      const r = Math.round(q*10)/10;
      return r;
    }

    function guessAisle(name){
      const s = normalize(name);
      if(!s) return "Other";
      if(["spinach","kale","cucumber","tomato","avocado","onion","garlic","pepper","carrot","zucchini","asparagus","broccoli","cabbage","brussels","greens","lemon","lime","eggplant","mushroom","arugula","parsley","cilantro"].some(k=>s.includes(k))) return "Produce";
      if(["frozen","cauliflower rice"].some(k=>s.includes(k))) return "Frozen";
      if(["yogurt","parmesan","feta","eggs","butter"].some(k=>s.includes(k))) return "Dairy";
      if(["tortilla","bread"].some(k=>s.includes(k))) return "Bakery";
      if(["hummus","pesto","polenta"].some(k=>s.includes(k))) return "Deli/Prepared";
      if(["soy","vinegar","mustard","seasoning","miso","sriracha","harissa","curry","oil"].some(k=>s.includes(k))) return "Spices/Sauces";
      return "Pantry";
    }

    function groceriesToCSV(flat){
      const header = ["Aisle","Item","Quantity","Unit","Notes"];
      const rows = flat.map(it => [it.aisle, it.name, String(it.qty), it.unit, ""]);
      const esc = (v) => {
        const s = String(v ?? "");
        if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      return [header, ...rows].map(r => r.map(esc).join(",")).join("\n");
    }

    function groceriesToTSV(flat){
      const header = ["Aisle","Item","Quantity","Unit","Notes"];
      const rows = flat.map(it => [it.aisle, it.name, String(it.qty), it.unit, ""]);
      return [header, ...rows].map(r => r.join("\t")).join("\n");
    }

    function downloadText(filename, text, mime="text/plain"){
      const blob = new Blob([text], {type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /**********************
     * UI Components
     **********************/
    function TextListEditor({title, items, setItems, placeholder, hint}){
      const [val,setVal] = React.useState("");
      const add = () => {
        const v = val.trim();
        if(!v) return;
        const next = [...items, v];
        setItems(next);
        setVal("");
      };
      const removeAt = (idx) => {
        const next = items.filter((_,i)=>i!==idx);
        setItems(next);
      };
      return (
        <div className="card">
          <h2>{title}</h2>
          <div className="row">
            <input
              style={{flex:1, minWidth:180}}
              value={val}
              placeholder={placeholder}
              onChange={e=>setVal(e.target.value)}
              onKeyDown={e=>{ if(e.key==="Enter"){ e.preventDefault(); add(); } }}
            />
            <button className="btn" onClick={add}>Add <span className="kbd">Enter</span></button>
          </div>
          {hint ? <div className="footnote">{hint}</div> : null}
          <div className="sep"></div>
          <div className="chipwrap">
            {items.map((it,idx)=>(
              <span key={idx} className="tag">
                {it}
                <button className="btn small ghost danger" style={{marginLeft:6}} onClick={()=>removeAt(idx)}>×</button>
              </span>
            ))}
            {!items.length ? <span className="muted small">No items yet.</span> : null}
          </div>
        </div>
      );
    }

    function InventoryCard({inventory, setInventory}){
      const set = (k, v) => {
        const n = {...inventory, [k]: clamp(Number(v||0),0,999)};
        setInventory(n);
      };
      return (
        <div className="card">
          <h2>Costco Protein Inventory (lbs)</h2>
          <div className="list">
            {proteinOrder.map(p => (
              <div className="item" key={p}>
                <div className="meta">
                  <div className="name" style={{textTransform:"capitalize"}}>{p}</div>
                  <div className="sub">Tracked in pounds</div>
                </div>
                <input type="number" value={inventory[p] ?? 0} onChange={e=>set(p, e.target.value)} />
              </div>
            ))}
          </div>
          <div className="footnote">Inventory decreases when you mark a dinner <strong>Done</strong>.</div>
        </div>
      );
    }

    function SettingsCard({settings, setSettings}){
      const set = (k,v) => setSettings({...settings, [k]: v});
      const ozMale = Number(settings.ozMale||0);
      const ozFemale = Number(settings.ozFemale||0);
      const lbs = (ozMale+ozFemale)/16;

      return (
        <div className="card">
          <h2>Planner Settings</h2>

          <div className="row">
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Dinner nights</label>
              <input type="number" value={settings.dinnerNights} onChange={e=>set("dinnerNights", clamp(Number(e.target.value||0),0,7))} />
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Leftover nights</label>
              <input type="number" value={settings.leftoverNights} onChange={e=>set("leftoverNights", clamp(Number(e.target.value||0),0,7))} />
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Avoid last N days</label>
              <input type="number" value={settings.avoidDays} onChange={e=>set("avoidDays", clamp(Number(e.target.value||0),0,60))} />
            </div>
          </div>

          <div className="sep"></div>

          <div className="row" style={{alignItems:"flex-start"}}>
            <div style={{flex:1}}>
              <div className="switch">
                <input type="checkbox" checked={!!settings.healthyMode} onChange={e=>set("healthyMode", e.target.checked)} />
                <div>
                  <div style={{fontSize:13,fontWeight:650}}>Healthy Mode</div>
                  <div className="muted small">Caps + scoring bias</div>
                </div>
              </div>
            </div>

            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Max processed / week</label>
              <input type="number" disabled={!settings.healthyMode} value={settings.maxProcessed} onChange={e=>set("maxProcessed", clamp(Number(e.target.value||0),0,7))} />
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Max refined-carb / week</label>
              <input type="number" disabled={!settings.healthyMode} value={settings.maxRefined} onChange={e=>set("maxRefined", clamp(Number(e.target.value||0),0,7))} />
            </div>
          </div>

          <div className="row">
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Veg-forward bias (0–4)</label>
              <input type="number" disabled={!settings.healthyMode} value={settings.vegForwardBias} onChange={e=>set("vegForwardBias", clamp(Number(e.target.value||0),0,4))} />
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Penalize unhealthy (0–4)</label>
              <input type="number" disabled={!settings.healthyMode} value={settings.penalizeUnhealthy} onChange={e=>set("penalizeUnhealthy", clamp(Number(e.target.value||0),0,4))} />
            </div>
          </div>

          <div className="sep"></div>

          <h2 style={{marginTop:0}}>Portions</h2>
          <div className="row">
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Male oz / dinner</label>
              <input type="number" value={settings.ozMale} onChange={e=>set("ozMale", clamp(Number(e.target.value||0),0,20))} />
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Female oz / dinner</label>
              <input type="number" value={settings.ozFemale} onChange={e=>set("ozFemale", clamp(Number(e.target.value||0),0,20))} />
            </div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>
              <label>Calculated lbs / dinner</label>
              <input className="mono" value={lbs.toFixed(2)} readOnly />
            </div>
          </div>
        </div>
      );
    }

    function PlanCard({idx, dinner, meal, onView, onDone, onSwap, onSkip}){
      const status = dinner.status;
      const tags = [];
      if(status==="done") tags.push(<span key="done" className="tag ok">Done</span>);
      if(status==="skipped") tags.push(<span key="skip" className="tag warn">Declined</span>);
      if(status==="leftover") tags.push(<span key="lo" className="tag">Leftovers</span>);
      if(meal){
        if(meal.processed) tags.push(<span key="proc" className="tag bad">processed</span>);
        if(meal.refinedCarb) tags.push(<span key="ref" className="tag warn">refined</span>);
        if(meal.vegForward) tags.push(<span key="veg" className="tag ok">veg-forward</span>);
        tags.push(<span key="prot" className="tag">{meal.protein}</span>);
        tags.push(<span key="cui" className="tag">{meal.cuisine}</span>);
      }

      return (
        <div className="planCard">
          <div className="planCardHeader">
            <div style={{minWidth:0}}>
              <div className="titleLine">
                <span className="tag">Night {idx+1}</span>
                <div className="mealName" style={{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>
                  {status==="leftover" ? "Leftovers / Out" : (meal ? meal.name : "—")}
                </div>
              </div>
              <div className="chipwrap" style={{marginTop:8}}>{tags}</div>
              {meal ? (
                <div className="metaLine">
                  Veg: {meal.vegTags.join(", ") || "—"} · Side: {(meal.sideTags[0]||"none")}
                </div>
              ) : null}
            </div>

            <div className="actions">
              {status!=="leftover" && meal ? (
                <>
                  <button className="btn small" onClick={onView}>View recipe</button>
                  <button className="btn small good" onClick={onDone} disabled={status==="done"}>Done</button>
                  <button className="btn small" onClick={onSwap}>Swap</button>
                  <button className="btn small danger" onClick={onSkip}>Decline</button>
                </>
              ) : (
                <span className="muted small">No shopping items</span>
              )}
            </div>
          </div>
        </div>
      );
    }

    function RecipeModal({open, onClose, meal, dinner, onToggleRemove}){
      if(!open || !meal || !dinner) return null;
      const removedSet = new Set((dinner.removed||[]).map(normalize));

      return (
        <div className="modalOverlay" onMouseDown={(e)=>{ if(e.target.classList.contains("modalOverlay")) onClose(); }}>
          <div className="modal" role="dialog" aria-modal="true">
            <button className="btn small xbtn" onClick={onClose}>Close</button>
            <h3>{meal.name}</h3>
            <div className="subhead">
              <span className="tag">{meal.protein}</span>{" "}
              <span className="tag">{meal.cuisine}</span>{" "}
              {meal.processed ? <span className="tag bad">processed</span> : null}{" "}
              {meal.refinedCarb ? <span className="tag warn">refined</span> : null}{" "}
              {meal.vegForward ? <span className="tag ok">veg-forward</span> : null}
              <div style={{marginTop:8}} className="muted small">
                Tip: Click <strong>Exclude</strong> next to an ingredient to remove it from <em>this week’s grocery list</em> (does not change the recipe library).
              </div>
            </div>

            <div className="modalSection">
              <h4>Ingredients</h4>
              <div className="ingList">
                {meal.ingredients.map((ing, i) => {
                  const removed = removedSet.has(normalize(ing.name)) || removedSet.has(normalize(ing.id));
                  return (
                    <div className="ingRow" key={ing.id + ":" + i}>
                      <div className="left">
                        <div className="nm" style={{textDecoration: removed ? "line-through" : "none", opacity: removed ? 0.6 : 1}}>
                          {ing.name}
                        </div>
                        <div className="meta">
                          {ing.qty} {ing.unit} · {ing.aisle}
                        </div>
                      </div>
                      <button
                        className={"btn small " + (removed ? "good" : "danger")}
                        onClick={()=>onToggleRemove(ing.name)}
                        title={removed ? "Include this ingredient again" : "Exclude from grocery list for this meal"}
                      >
                        {removed ? "Included" : "Exclude"}
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="modalSection">
              <h4>Steps</h4>
              <ol className="stepList">
                {meal.steps.map((s,idx)=>(<li key={idx}>{s}</li>))}
              </ol>
            </div>
          </div>
        </div>
      );
    }

    /**********************
     * App
     **********************/
    function App(){
      const [state, setState] = React.useState(() => safeLoad() || defaultState());

      // persist
      React.useEffect(()=>{ safeSave(state); }, [state]);

      // Derived grocery list
      const grocery = React.useMemo(()=> buildGrocery(state), [state]);
      const groceryFlatSorted = React.useMemo(()=>{
        // Sort by aisle order then name
        const order = new Map(aisleOrder.map((a,i)=>[a,i]));
        return [...grocery.flat].sort((a,b)=>{
          const ai = order.has(a.aisle)?order.get(a.aisle):999;
          const bi = order.has(b.aisle)?order.get(b.aisle):999;
          if(ai!==bi) return ai-bi;
          return normalize(a.name).localeCompare(normalize(b.name));
        });
      }, [grocery.flat]);

      // modal state
      const [modal, setModal] = React.useState({open:false, dinnerId:null});
      const currentDinner = React.useMemo(()=>{
        if(!state.plan || !modal.dinnerId) return null;
        return state.plan.dinners.find(d=>d.id===modal.dinnerId) || null;
      }, [state.plan, modal.dinnerId]);
      const currentMeal = React.useMemo(()=>{
        if(!currentDinner || !currentDinner.mealId) return null;
        return MEAL_BY_ID.get(currentDinner.mealId) || null;
      }, [currentDinner]);

      function updateSettings(next){ setState(s => ({...s, settings: next})); }
      function updateInventory(next){ setState(s => ({...s, inventory: next})); }
      function updatePantry(next){ setState(s => ({...s, pantry: next})); }
      function updateStaples(next){ setState(s => ({...s, staples: next})); }
      function updateSnacks(next){ setState(s => ({...s, snacks: next})); }

      function doGenerate(){
        setState(s => ({...s, plan: generatePlan(s)}));
      }

      function doResetPlan(){
        setState(s => ({...s, plan: null}));
      }

      function markDone(dinnerId){
        setState(s => {
          if(!s.plan) return s;
          const plan = {...s.plan};
          const dinners = plan.dinners.map(d => {
            if(d.id !== dinnerId) return d;
            if(d.status === "done") return d;
            return {...d, status:"done"};
          });

          // consume protein + record history
          const d0 = plan.dinners.find(d=>d.id===dinnerId);
          if(!d0 || !d0.mealId) return {...s, plan: {...plan, dinners}};
          const meal = MEAL_BY_ID.get(d0.mealId);
          if(!meal) return {...s, plan: {...plan, dinners}};

          const lbsNeeded = computeProteinLbsPerDinner(s.settings);
          const inv = {...s.inventory};
          inv[meal.protein] = Math.max(0, Number(inv[meal.protein]||0) - lbsNeeded);

          const history = [...s.history, {mealId: meal.id, atISO: nowISO()}];

          return {...s, plan: {...plan, dinners}, inventory: inv, history};
        });
      }

      function declineDinner(dinnerId){
        setState(s => {
          if(!s.plan) return s;
          const plan = {...s.plan};
          plan.dinners = plan.dinners.map(d => d.id===dinnerId ? {...d, status:"skipped"} : d);
          return {...s, plan};
        });
      }

      function swapDinner(dinnerId){
        setState(s => {
          if(!s.plan) return s;
          const plan = {...s.plan};
          const dinner = plan.dinners.find(d=>d.id===dinnerId);
          if(!dinner || !dinner.mealId) return s;

          // Generate a replacement using current week constraints:
          const settings = s.settings;
          const recentSet = getRecentMealSet(s.history, Number(settings.avoidDays||0));
          const already = new Set(plan.dinners.filter(d=>d.mealId).map(d=>d.mealId));
          already.delete(dinner.mealId);

          const proteinLbsNeeded = computeProteinLbsPerDinner(settings);

          // build counts from current plan (excluding the dinner being swapped)
          const usedVegCount = new Map();
          const usedCuisineCount = new Map();
          let lastProtein = null;
          let processedUsed = 0;
          let refinedUsed = 0;

          for(const d of plan.dinners){
            if(d.id===dinnerId) continue;
            if(!d.mealId) continue;
            const m = MEAL_BY_ID.get(d.mealId);
            if(!m) continue;
            for(const v of m.vegTags) usedVegCount.set(v, (usedVegCount.get(v)||0)+1);
            usedCuisineCount.set(m.cuisine, (usedCuisineCount.get(m.cuisine)||0)+1);
            lastProtein = m.protein;
            if(settings.healthyMode){
              if(m.processed) processedUsed++;
              if(m.refinedCarb) refinedUsed++;
            }
          }

          const candidates = MEALS.filter(m => !recentSet.has(m.id) && !already.has(m.id));

          const scored = [];
          for(const meal of candidates){
            if(settings.healthyMode){
              if(meal.processed && processedUsed >= settings.maxProcessed) continue;
              if(meal.refinedCarb && refinedUsed >= settings.maxRefined) continue;
            }
            scored.push([scoreMeal(meal, {usedVegCount, usedCuisineCount, lastProtein, inventory: s.inventory, proteinLbsNeeded, settings}), meal]);
          }
          scored.sort((a,b)=>b[0]-a[0]);

          const pick = scored.length ? scored[0][1] : null;
          if(!pick) return s;

          plan.dinners = plan.dinners.map(d => d.id===dinnerId ? {...d, mealId: pick.id, status:"planned", removed: []} : d);
          return {...s, plan};
        });
      }

      function toggleRemoveIngredient(dinnerId, ingredientName){
        setState(s => {
          if(!s.plan) return s;
          const plan = {...s.plan};
          plan.dinners = plan.dinners.map(d => {
            if(d.id !== dinnerId) return d;
            const removed = new Set((d.removed||[]).map(normalize));
            const key = normalize(ingredientName);
            if(removed.has(key)) removed.delete(key);
            else removed.add(key);
            return {...d, removed: Array.from(removed)};
          });
          return {...s, plan};
        });
      }

      async function copyTSV(){
        const tsv = groceriesToTSV(groceryFlatSorted);
        try{
          await navigator.clipboard.writeText(tsv);
          alert("Copied grocery list as TSV (paste into Sheets/Excel).");
        }catch(e){
          console.warn(e);
          // fallback
          const ta = document.createElement("textarea");
          ta.value = tsv;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          alert("Copied grocery list as TSV (fallback).");
        }
      }

      function downloadCSV(){
        const csv = groceriesToCSV(groceryFlatSorted);
        downloadText(`grocery-list-${new Date().toISOString().slice(0,10)}.csv`, csv, "text/csv");
      }

      const plan = state.plan;

      return (
        <div className="wrap">
          <div className="topbar">
            <div className="title">
              <h1>Weekly Meal Planner</h1>
              <p>Static, device-only planner (localStorage). Generate dinners, track Costco proteins, and build a Trader Joe’s grocery list.</p>
              <div className="pillrow">
                <span className="pill">Storage key: <span className="mono">{STORAGE_KEY}</span></span>
                <span className="pill">Meals in library: <strong>{MEALS.length}</strong></span>
                <span className="pill">Healthy mode: <strong>{state.settings.healthyMode ? "ON" : "OFF"}</strong></span>
              </div>
            </div>

            <div className="hstack" style={{justifyContent:"flex-end"}}>
              <button className="btn primary" onClick={doGenerate}>Generate week</button>
              <button className="btn" onClick={doResetPlan} disabled={!plan}>Clear plan</button>
            </div>
          </div>

          <div className="grid">
            {/* Left column */}
            <div className="leftcol" style={{display:"flex",flexDirection:"column",gap:14}}>
              <SettingsCard settings={state.settings} setSettings={updateSettings} />
              <InventoryCard inventory={state.inventory} setInventory={updateInventory} />
              <TextListEditor
                title="Pantry (fuzzy subtraction)"
                items={state.pantry}
                setItems={updatePantry}
                placeholder='e.g., "yogurt" (will remove "greek yogurt")'
                hint='Pantry items are fuzzy-matched against grocery list items (substring match either direction). Press Enter to add.'
              />
              <TextListEditor
                title="Weekly staples (always buy)"
                items={state.staples}
                setItems={updateStaples}
                placeholder='e.g., "mixed greens"'
                hint='Staples are added as 1 each unless pantry already covers them.'
              />
              <TextListEditor
                title="Fun snacks (optional)"
                items={state.snacks}
                setItems={updateSnacks}
                placeholder='e.g., "chips & guac"'
                hint='Snacks are added as 1 each unless pantry covers them.'
              />
            </div>

            {/* Right column */}
            <div className="rightcol">
              <div className="card">
                <h2>This Week</h2>
                {!plan ? (
                  <div className="muted small">Click <strong>Generate week</strong> to create your dinner plan.</div>
                ) : (
                  <>
                    <div className="kv">
                      <div>Generated</div>
                      <strong>{new Date(plan.generatedAtISO).toLocaleString()}</strong>
                    </div>
                    <div className="kv">
                      <div>Cook nights</div>
                      <strong>{Math.max(0, plan.dinnersCount - plan.leftoversCount)}</strong>
                    </div>
                    <div className="kv">
                      <div>Leftovers nights</div>
                      <strong>{plan.leftoversCount}</strong>
                    </div>

                    <div className="sep"></div>

                    <div className="planGrid">
                      {plan.dinners.map((d, idx) => {
                        const meal = d.mealId ? MEAL_BY_ID.get(d.mealId) : null;
                        return (
                          <PlanCard
                            key={d.id}
                            idx={idx}
                            dinner={d}
                            meal={meal}
                            onView={() => setModal({open:true, dinnerId:d.id})}
                            onDone={() => markDone(d.id)}
                            onSwap={() => swapDinner(d.id)}
                            onSkip={() => declineDinner(d.id)}
                          />
                        );
                      })}
                    </div>

                    <div className="footnote">
                      Tip: in recipe view you can <strong>Exclude</strong> any ingredient for this week only (it will disappear from the grocery list).
                    </div>
                  </>
                )}
              </div>

              <div className="card">
                <div className="row" style={{justifyContent:"space-between",alignItems:"center"}}>
                  <h2 style={{margin:0}}>Trader Joe’s Grocery List</h2>
                  <div className="hstack">
                    <button className="btn small" onClick={copyTSV} disabled={!groceryFlatSorted.length}>Copy TSV</button>
                    <button className="btn small primary" onClick={downloadCSV} disabled={!groceryFlatSorted.length}>Download CSV</button>
                  </div>
                </div>

                {!plan ? (
                  <div className="muted small">Generate a week to see a grocery list.</div>
                ) : (
                  <>
                    <div className="footnote">
                      Export formats are editable in Sheets/Excel. CSV downloads as a file; TSV copies to clipboard for quick paste.
                    </div>

                    {aisleOrder.filter(a => grocery.aisles.has(a)).map(a => (
                      <div className="gAisle" key={a}>
                        <div className="gHead">
                          <strong>{a}</strong>
                          <span className="muted small">{grocery.aisles.get(a).length} items</span>
                        </div>
                        <div className="gBody">
                          {grocery.aisles.get(a).map((it,idx)=>(
                            <div className="gItem" key={a + ":" + idx}>
                              <div className="left">
                                <div className="nm">{it.name}</div>
                                <div className="note">{it.unit}</div>
                              </div>
                              <div className="qty">{it.qty}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}

                    {/* Any aisles not in the preferred order */}
                    {[...grocery.aisles.keys()].filter(a => !aisleOrder.includes(a)).map(a => (
                      <div className="gAisle" key={a}>
                        <div className="gHead">
                          <strong>{a}</strong>
                          <span className="muted small">{grocery.aisles.get(a).length} items</span>
                        </div>
                        <div className="gBody">
                          {grocery.aisles.get(a).map((it,idx)=>(
                            <div className="gItem" key={a + ":" + idx}>
                              <div className="left">
                                <div className="nm">{it.name}</div>
                                <div className="note">{it.unit}</div>
                              </div>
                              <div className="qty">{it.qty}</div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}

                    {!groceryFlatSorted.length ? (
                      <div className="muted small" style={{marginTop:10}}>
                        Nothing to buy — pantry/staples/snacks may be covering everything, or you have all leftovers.
                      </div>
                    ) : null}
                  </>
                )}
              </div>
            </div>
          </div>

          <RecipeModal
            open={modal.open}
            onClose={()=>setModal({open:false, dinnerId:null})}
            meal={currentMeal}
            dinner={currentDinner}
            onToggleRemove={(ingredientName)=> toggleRemoveIngredient(modal.dinnerId, ingredientName)}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
